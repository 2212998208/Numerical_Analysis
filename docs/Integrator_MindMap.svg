<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="1180" height="760" viewBox="0 0 1180 760" font-family="Segoe UI,Roboto,Helvetica,Arial,sans-serif">
  <defs>
    <style><![CDATA[
      .node { fill:#ffffff; stroke:#2c3e50; stroke-width:1.2; rx:8; ry:8; }
      .title { font-size:20px; font-weight:600; }
      .subtitle { font-size:14px; font-weight:600; fill:#2c3e50; }
      .text { font-size:13px; fill:#2c3e50; }
      .mono { font-family: "Consolas","Courier New",monospace; font-size:12px; }
      .line { stroke:#34495e; stroke-width:1.2; fill:none; }
      .dashed { stroke-dasharray:5 5; }
      .tag { fill:#34495e; font-size:11px; font-weight:600; letter-spacing:0.5px; }
      .pill { stroke:#34495e; stroke-width:1; fill:#ecf0f1; rx:10; ry:10; }
      .emph { fill:#c0392b; font-weight:600; }
      .ok { fill:#27ae60; font-weight:600; }
    ]]></style>
  </defs>
  <rect x="0" y="0" width="1180" height="760" fill="#f8fbfd"/>

  <!-- Root -->
  <g id="root">
    <rect class="node" x="500" y="40" width="180" height="70"/>
    <text x="590" y="70" text-anchor="middle" class="title">数值积分核心</text>
    <text x="590" y="92" text-anchor="middle" class="text">Runge–Kutta 4 阶 (RK4)</text>
  </g>

  <!-- API 设计 -->
  <g id="api">
    <rect class="node" x="120" y="170" width="240" height="170"/>
    <text x="240" y="198" text-anchor="middle" class="subtitle">API and 数据结构</text>
    <text class="mono" x="135" y="222">IntegrandFn: double f(x, user)</text>
    <text class="mono" x="135" y="242">AdaptiveConfig { abs_tol, rel_tol, max_iterations }</text>
    <text class="mono" x="135" y="262">Integrator.rk4_fixed(...)</text>
    <text class="mono" x="135" y="282">Integrator.rk4_adaptive(...)</text>
    <text class="text" x="135" y="305">返回值: 积分近似值</text>
    <text class="text" x="135" y="325">状态: INTEGRATOR_OK / MAX_STEPS</text>
  </g>

  <!-- 数学模型 -->
  <g id="model">
    <rect class="node" x="450" y="160" width="260" height="150"/>
    <text x="580" y="186" text-anchor="middle" class="subtitle">数学转化</text>
    <text x="465" y="210" class="mono">I = ∫_a^b f(x) dx</text>
    <text x="465" y="230" class="mono">引入: y(x) = ∫_a^x f(t) dt</text>
    <text x="465" y="250" class="mono">⇒ y'(x) = f(x), y(a)=0</text>
    <text x="465" y="272" class="text">用 ODE 数值法推进 y</text>
    <text x="465" y="292" class="text">最终 y(b) ≈ I</text>
  </g>

  <!-- 固定步长 -->
  <g id="fixed">
    <rect class="node" x="830" y="150" width="260" height="190"/>
    <text x="960" y="178" text-anchor="middle" class="subtitle">固定步长 rk4_fixed</text>
    <text x="845" y="202" class="mono">h = (b - a)/steps</text>
    <text x="845" y="222" class="mono">重复: y = RK4_step(x, y, h)</text>
    <text x="845" y="242" class="mono">x += h</text>
    <text x="845" y="262" class="text">时间复杂度: O(steps)</text>
    <text x="845" y="282" class="text">误差 ~ O(h^4)</text>
    <text x="845" y="302" class="text">k2 = k3 复用以少一次求值</text>
    <text x="845" y="322" class="text">适合平滑函数/均匀精度需求</text>
  </g>

  <!-- 自适应 -->
  <g id="adaptive">
    <rect class="node" x="150" y="400" width="320" height="240"/>
    <text x="310" y="428" text-anchor="middle" class="subtitle">自适应 rk4_adaptive (全局加倍)</text>
    <text x="165" y="452" class="mono">初始 steps = 8</text>
    <text x="165" y="472" class="mono">循环: steps *= 2</text>
    <text x="165" y="492" class="mono">I_h, I_{h/2}</text>
    <text x="165" y="512" class="mono">E = |I_{h/2} - I_h| / 15</text>
    <text x="165" y="532" class="mono">阈值 = max(abs_tol, |I| * rel_tol)</text>
    <text x="165" y="552" class="text">若 E ≤ 阈值 ⇒ 收敛返回</text>
    <text x="165" y="572" class="text">否则继续 (至 max_iterations)</text>
    <text x="165" y="592" class="text emph">未收敛 ⇒ 状态 = MAX_STEPS</text>
    <text x="165" y="612" class="text">优点: 实现简单</text>
    <text x="165" y="632" class="text">缺点: 非局部, 可能浪费</text>
  </g>

  <!-- 误差推导 -->
  <g id="error">
    <rect class="node" x="520" y="400" width="260" height="210"/>
    <text x="650" y="428" text-anchor="middle" class="subtitle">误差估计 (Richardson)</text>
    <text x="535" y="452" class="mono">I_h   = I + C h^4 + O(h^5)</text>
    <text x="535" y="472" class="mono">I_{h/2}=I + C (h/2)^4 + ...</text>
    <text x="535" y="492" class="mono">差值 = -15/16 C h^4</text>
    <text x="535" y="512" class="mono">⇒ C h^4 ≈ (I_{h/2}-I_h)/15</text>
    <text x="535" y="535" class="text">阈值融合绝对+相对</text>
    <text x="535" y="555" class="text">避免 I≈0 时相对误差发散</text>
    <text x="535" y="575" class="text ok">成功: INTEGRATOR_OK</text>
  </g>

  <!-- 测试 -->
  <g id="tests">
    <rect class="node" x="840" y="420" width="270" height="200"/>
    <text x="975" y="448" text-anchor="middle" class="subtitle">测试 (tests.c)</text>
    <text x="855" y="472" class="mono">f1: x^2  (0→2) = 8/3</text>
    <text x="855" y="492" class="mono">f2: sin  (0→π) = 2</text>
    <text x="855" y="512" class="mono">f3: exp  (0→1) = e - 1</text>
    <text x="855" y="532" class="text">固定步: steps=2000</text>
    <text x="855" y="552" class="text">自适应: tol=1e-10</text>
    <text x="855" y="572" class="text">双容差: abs + rel</text>
  </g>

  <!-- 连接线 -->
  <g id="lines" stroke-linecap="round">
    <path class="line" d="M590 110 L590 160"/>
    <path class="line" d="M590 110 L360 170"/>
    <path class="line" d="M590 110 L950 150"/>
    <path class="line" d="M380 340 L310 400"/>
    <path class="line" d="M590 310 L650 400"/>
    <path class="line" d="M710 310 L960 420"/>
  </g>

  <!-- 标签 -->
  <g id="tags">
    <rect class="pill" x="552" y="120" width="76" height="24"/>
    <text x="590" y="137" text-anchor="middle" class="tag">RK4 核心</text>
    <rect class="pill" x="210" y="350" width="110" height="24"/>
    <text x="265" y="367" text-anchor="middle" class="tag">自适应流程</text>
    <rect class="pill" x="905" y="360" width="110" height="24"/>
    <text x="960" y="377" text-anchor="middle" class="tag">测试验证</text>
  </g>

  <!-- 角标 -->
  <text x="1160" y="746" text-anchor="end" font-size="11" fill="#7f8c8d">Generated: Numerical_Analysis MindMap</text>
</svg>

